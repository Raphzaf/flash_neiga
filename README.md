# Flash Neiga - Driving Test Preparation App

A comprehensive web application for preparing for driving theory exams, featuring a React frontend and FastAPI backend.

## üèóÔ∏è Project Structure

```
flash_neiga/
‚îú‚îÄ‚îÄ backend/          # FastAPI backend application
‚îÇ   ‚îú‚îÄ‚îÄ server.py     # Main FastAPI application
‚îÇ   ‚îú‚îÄ‚îÄ database.py   # Database configuration
‚îÇ   ‚îú‚îÄ‚îÄ models.py     # Data models
‚îÇ   ‚îî‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ frontend/         # React frontend application
‚îú‚îÄ‚îÄ data/            # Sample questions and data
‚îî‚îÄ‚îÄ render.yaml      # Render deployment configuration
```

## üöÄ Deployment

### Backend Deployment on Render

The backend is configured to deploy on Render using the `render.yaml` configuration file.

#### Prerequisites

1. A Render account ([sign up here](https://render.com))
2. GitHub repository connected to Render

#### Deployment Steps

1. **Connect Repository to Render**
   - Go to [Render Dashboard](https://dashboard.render.com)
   - Click "New +" and select "Blueprint"
   - Connect your GitHub repository
   - Select the `flash_neiga` repository

2. **Render will automatically detect `render.yaml`**
   - The configuration includes:
     - Web service: `flash-neiga-backend`
     - Python environment (3.11)
     - PostgreSQL database (free tier)
     - Auto-generated SECRET_KEY

3. **Set Environment Variables** (Optional)
   
   The following environment variables can be configured in Render Dashboard:
   
   - `SECRET_KEY` - Auto-generated by Render (or set your own)
   - `PYTHON_VERSION` - Set to "3.11" (default)
   - `DATABASE_URL` - Auto-configured from PostgreSQL database
   - `ALLOWED_ORIGINS` - Comma-separated list of allowed frontend URLs (e.g., `https://your-frontend.netlify.app,http://localhost:3000`)
   - `ADMIN_TOKEN` - (Optional) Token for admin endpoints
   - `STRIPE_SECRET_KEY` - (Optional) For payment integration

4. **Deploy**
   - Click "Apply" to start deployment
   - Wait for build and deployment to complete
   - Your API will be available at: `https://flash-neiga-backend.onrender.com`

#### Health Check

The backend includes a health check endpoint at `/health` that Render uses to monitor service status:

```bash
curl https://flash-neiga-backend.onrender.com/health
```

Expected response:
```json
{
  "status": "healthy",
  "service": "flash-neiga-backend",
  "timestamp": "2025-12-14T00:00:00.000000+00:00"
}
```

#### Database Configuration

The application uses **PostgreSQL** for production on Render (free tier) and **SQLite** for local development.

- **Production (Render)**: PostgreSQL database is automatically provisioned and configured
- **Local Development**: SQLite database (`flash_neiga.db`) is created in the `backend/` directory

The backend automatically detects the environment and uses the appropriate database:
- When `DATABASE_URL` environment variable is set ‚Üí PostgreSQL
- When `DATABASE_URL` is not set ‚Üí SQLite (local development)

### Frontend Deployment on Netlify

The frontend is deployed on Netlify using a **dual approach** (CORS + Proxy) for maximum reliability and security.

#### How it Works

This setup uses **two layers of connection handling**:

1. **Netlify Proxy** (Primary): API requests to `/api/*` are proxied through Netlify to Render
   - Avoids CORS issues entirely (same-origin requests)
   - Configured in `netlify.toml`
   - Frontend uses relative paths in production

2. **CORS Headers** (Backup): Backend explicitly allows Netlify origins
   - Configured in `backend/server.py`
   - Provides fallback if proxy has issues
   - Supports development with localhost

**Request Flow:**
```
Development:  http://localhost:3000 ‚Üí http://localhost:8000
Production:   https://app.netlify.app ‚Üí /api/* ‚Üí Netlify Proxy ‚Üí https://backend.onrender.com
```

#### Prerequisites

1. A Netlify account ([sign up here](https://www.netlify.com))
2. Your backend deployed on Render and accessible via HTTPS
3. GitHub repository connected to Netlify
4. **Your Render backend URL** (e.g., `https://flash-neiga-backend.onrender.com`)

#### Deployment Steps

1. **Update `netlify.toml` with your Render Backend URL**
   
   Before deploying, edit the `netlify.toml` file at the root of the repository:
   
   ```toml
   [[redirects]]
     from = "/api/*"
     to = "https://YOUR-SERVICE-NAME.onrender.com/api/:splat"  # ‚Üê Update this
     status = 200
     force = true
   ```
   
   Replace `YOUR-SERVICE-NAME` with your actual Render service name.

2. **Connect Repository to Netlify**
   - Go to [Netlify Dashboard](https://app.netlify.com)
   - Click "Add new site" ‚Üí "Import an existing project"
   - Connect your GitHub repository
   - Select the `flash_neiga` repository

3. **Configure Build Settings**
   
   Netlify should auto-detect settings from `netlify.toml`, but verify:
   - Base directory: `frontend`
   - Build command: `npm run build`
   - Publish directory: `build`

4. **Set Environment Variables** (Optional)
   
   In Netlify Dashboard ‚Üí Site settings ‚Üí Environment variables:
   
   **Note:** `REACT_APP_BACKEND_URL` is **NOT needed** for production (proxy handles it).
   Only set it if you want to override the proxy for testing.
   
   **Optional (for Stripe payments):**
   - `REACT_APP_STRIPE_PUBLISHABLE_KEY` - Your Stripe publishable key (starts with `pk_test_` or `pk_live_`)
   - `REACT_APP_STRIPE_PRICE_CODE_14D` - Stripe Price ID for 14-day code access
   - `REACT_APP_STRIPE_PRICE_CODE_30D` - Stripe Price ID for 30-day code access
   - `REACT_APP_STRIPE_PRICE_VIDEO_1M` - Stripe Price ID for 1-month video access
   - `REACT_APP_STRIPE_PRICE_VIDEO_2M` - Stripe Price ID for 2-month video access
   - `REACT_APP_STRIPE_PRICE_VIDEO_3M` - Stripe Price ID for 3-month video access
   - `REACT_APP_STRIPE_PRICING_TABLE_ID` - Stripe Pricing Table ID (starts with `prctbl_`)

5. **Deploy**
   - Click "Deploy site"
   - Wait for build and deployment to complete
   - Your application will be available at: `https://your-site-name.netlify.app`

6. **Update Backend CORS Settings** (Optional but recommended)
   
   For extra security, update your Render backend environment variables:
   - Set `ALLOWED_ORIGINS`: `https://your-site-name.netlify.app,http://localhost:3000`
   
   This ensures the backend explicitly allows your Netlify domain.

#### How to Get Your Render Backend URL

1. Go to [Render Dashboard](https://dashboard.render.com)
2. Click on your `flash-neiga-backend` service
3. Copy the URL at the top (e.g., `https://flash-neiga-backend.onrender.com`)
4. Use this URL in `netlify.toml`

#### Troubleshooting

**Issue: "ERR_CONNECTION_REFUSED" or "Failed to fetch"**
- ‚úÖ Verify `netlify.toml` has correct Render backend URL
- ‚úÖ Check that the backend is running: visit `https://your-backend.onrender.com/health`
- ‚úÖ Ensure backend URL in `netlify.toml` includes `/api/:splat` at the end
- ‚úÖ Redeploy Netlify after updating `netlify.toml`
- ‚úÖ Check browser DevTools ‚Üí Network tab for failed requests

**Issue: CORS errors in production**
- ‚úÖ Verify `ALLOWED_ORIGINS` includes your Netlify URL in Render environment variables
- ‚úÖ Make sure backend URL in `netlify.toml` is correct
- ‚úÖ Check that backend has `allow_credentials=True` in CORS config
- ‚úÖ Redeploy backend after changing CORS settings

**Issue: API requests returning 404**
- ‚úÖ Ensure API calls use `/api/...` paths (e.g., `/api/auth/login`)
- ‚úÖ Verify `netlify.toml` redirect rule is correct (should include `:splat`)
- ‚úÖ Check that backend routes start with `/api/`

**Issue: Environment variables not working**
- ‚úÖ Only Stripe variables need to be set in Netlify (no need for `REACT_APP_BACKEND_URL`)
- ‚úÖ Redeploy the site after adding/changing environment variables
- ‚úÖ Variable names must start with `REACT_APP_` (required by Create React App)

**Issue: 401 Unauthorized errors**
- ‚úÖ Clear browser localStorage and login again
- ‚úÖ Check that JWT token is being sent in requests (visible in Network tab)
- ‚úÖ Verify `withCredentials: true` is set in axios config

**Issue: Works locally but not in production**
- ‚úÖ Check browser console for errors
- ‚úÖ Verify `NODE_ENV=production` triggers proxy usage in `axiosConfig.js`
- ‚úÖ Test the backend health endpoint: `https://your-site.netlify.app/api/health` (should proxy)
- ‚úÖ Compare Network tab requests between local and production

## üîê Initial Setup - Create Admin User

After deploying the backend to Render (or setting it up locally), you need to create an admin user to access the admin panel.

### On Render:

1. Go to your [Render Dashboard](https://dashboard.render.com)
2. Select your backend service (`flash-neiga-backend`)
3. Click on **Shell** in the left menu
4. Run the following command:
   ```bash
   python create_admin.py
   ```

### Locally:

If running locally, simply execute:
```bash
cd backend
python create_admin.py
```

### Admin Credentials:

- **Email**: `admin@gmail.com`
- **Password**: `admin`

‚ö†Ô∏è **IMPORTANT**: Change the admin password after first login for security!

### Accessing Admin Panel:

1. Go to your frontend URL (Netlify or http://localhost:3000)
2. Login with the admin credentials
3. Navigate to `/admin` to manage questions and signs

### Resetting Admin Password:

If you forget the admin password, you can reset it using:

**On Render:**
```bash
# In the Render Shell
python reset_admin.py
```

**Locally:**
```bash
cd backend
python reset_admin.py
```

This will reset the password back to `admin`.

## üíª Local Development

### Backend Setup

1. **Navigate to backend directory**
   ```bash
   cd backend
   ```

2. **Install dependencies**
   ```bash
   pip install -r requirements.txt
   ```

3. **Run the server**
   ```bash
   # Development
   python server.py
   
   # Or with uvicorn directly
   uvicorn server:app --reload --host 0.0.0.0 --port 8000
   ```

4. **Access the API**
   - API: http://localhost:8000
   - API Documentation: http://localhost:8000/docs
   - Health Check: http://localhost:8000/health

### Frontend Setup

1. **Navigate to frontend directory**
   ```bash
   cd frontend
   ```

2. **Create environment file** (optional for local development)
   ```bash
   cp .env.example .env
   ```
   
   The default `.env` file includes:
   ```env
   REACT_APP_BACKEND_URL=http://localhost:8000
   ```
   
   For local development, this is already configured. Only modify if your backend runs on a different port.

3. **Install dependencies**
   ```bash
   npm install
   ```

4. **Run development server**
   ```bash
   npm start
   ```

5. **Access the application**
   - Frontend: http://localhost:3000
   - The frontend will automatically proxy API requests to `http://localhost:8000` via the configured `REACT_APP_BACKEND_URL`

## üîß Configuration

### Database

The backend supports both PostgreSQL (production) and SQLite (local development):

**Production (Render)**:
- Uses PostgreSQL (free tier)
- Database is automatically provisioned and managed by Render
- Connection string is auto-configured via `DATABASE_URL` environment variable
- Database name: `flash_neiga`
- User: `flash_neiga_user`

**Local Development**:
- Uses SQLite for simplicity
- Database file (`flash_neiga.db`) is stored in the `backend/` directory
- No configuration needed - automatically created on first run

### CORS Configuration

The backend uses a **dual approach** for handling cross-origin requests:

**Default Behavior:**
- Allows `localhost:3000`, `localhost:8000`, and `*.netlify.app` domains
- Configured in `backend/server.py`
- Supports credentials (cookies, auth tokens)

**Custom Configuration (Production):**

Set the `ALLOWED_ORIGINS` environment variable in Render to explicitly allow your domains:

```bash
ALLOWED_ORIGINS=https://your-site.netlify.app,https://custom-domain.com,http://localhost:3000
```

**How CORS Works with Netlify Proxy:**

1. **Primary**: Netlify proxy makes requests same-origin (no CORS needed)
2. **Fallback**: CORS headers allow direct requests if proxy fails
3. **Development**: CORS allows localhost connections for local testing

This dual approach ensures maximum reliability and compatibility.

## üìã API Endpoints

### Authentication
- `POST /api/auth/register` - Register new user
- `POST /api/auth/login` - Login user
- `GET /api/auth/me` - Get current user

### Questions
- `GET /api/questions` - Get all questions (with optional category filter)
- `POST /api/questions` - Create new question

### Exams
- `POST /api/exam/start` - Start new exam session
- `GET /api/exam/{exam_id}` - Get exam details
- `POST /api/exam/{exam_id}/answer` - Submit answer
- `POST /api/exam/{exam_id}/finish` - Finish exam
- `GET /api/exam/{exam_id}/details` - Get detailed exam results

### Training
- `POST /api/training/check` - Check training answer

### Stats
- `GET /api/stats/summary` - Get stats summary
- `GET /api/stats/details` - Get detailed stats

### Health
- `GET /health` - Health check endpoint

## üìö Question Management

### Automatic Import on First Startup

The backend automatically loads questions from `data_v3.json` when it starts for the first time with an empty database.

**Check Render logs to confirm:**
```
üìö Database is empty, loading questions from data_v3.json...
   ‚è≥ Imported 50 questions...
   ‚è≥ Imported 100 questions...
   ...
‚úÖ Successfully loaded 1802 questions from data_v3.json!
```

**What happens on startup:**
1. Database tables are created if they don't exist
2. Admin user is created if it doesn't exist
3. If the database has 0 questions, `data_v3.json` is automatically imported
4. Progress is logged every 50 questions

### Admin Panel Management

The admin panel provides a complete database management interface:

1. **Login as admin**: `admin@gmail.com` / `admin`
2. **Navigate to** `/admin`
3. **Select** "Base de donn√©es" (Database) tab

**Features:**
- **View Statistics**: See total questions and breakdown by category
- **Import Questions**: Manually import questions from `data_v3.json`
- **Refresh Statistics**: Update the statistics display
- **Clear Database**: Delete all questions (with confirmation)

### API Endpoints

Admin endpoints for programmatic access (requires authentication):

- `GET /api/admin/questions/stats` - Get database statistics
  ```json
  {
    "total_questions": 1802,
    "by_category": {
      "Code de la route": 450,
      "Signalisation": 320,
      "...": "..."
    },
    "database_type": "postgresql",
    "timestamp": "2025-12-14T00:00:00.000000"
  }
  ```

- `POST /api/admin/import-questions` - Manually import questions
  ```bash
  curl -X POST https://your-backend.onrender.com/api/admin/import-questions \
    -H "Authorization: Bearer YOUR_TOKEN" \
    -d '{"source": "data_v3", "force": false}'
  ```

- `DELETE /api/admin/questions/clear` - Clear all questions (requires confirmation)
  ```bash
  curl -X DELETE "https://your-backend.onrender.com/api/admin/questions/clear?confirm=true" \
    -H "Authorization: Bearer YOUR_TOKEN"
  ```

- `GET /api/questions?category=code` - Get questions by category (public endpoint)

### Troubleshooting

**No questions showing in exam/training mode:**
1. Check Render logs for import confirmation
2. Use admin panel to view statistics
3. Manually trigger import via admin panel
4. Verify `data_v3.json` exists in the repository

**Import not working:**
1. Ensure you're logged in as admin
2. Check browser console for errors
3. Verify backend logs in Render dashboard
4. Try clearing and re-importing

## üîê Security

- Passwords are hashed using bcrypt
- JWT tokens for authentication
- SECRET_KEY should be set in production (auto-generated by Render)
- CORS configured for production domains

### Admin User

The application automatically creates an admin user on first startup:

- **Email**: `admin@gmail.com`
- **Password**: `admin`

**Important Security Notes:**
- The admin user is created automatically on first deployment
- Check your Render logs to confirm admin user creation
- **You must change the admin password immediately after first login**
- The admin account provides full access to the system

**Checking Admin Creation in Render:**
1. Go to your Render Dashboard
2. Select your backend service
3. Click on "Logs" tab
4. Look for the admin user creation message:
   ```
   ‚úÖ Admin user created successfully!
      Email: admin@gmail.com
      Password: admin
      User ID: [generated-id]
   ‚ö†Ô∏è  IMPORTANT: Change the admin password after first login!
   ```

On subsequent restarts, you'll see:
```
‚ÑπÔ∏è  Admin user already exists: admin@gmail.com
```

## üìù License

[Add your license information here]

## ü§ù Contributing

[Add contribution guidelines here]
